<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="post_mapper">

	<insert id="savePostImages" parameterType="Image">
	INSERT INTO image
	(image_id, post_id, file_name, original_file_name, file_path, url_file_path, file_extension, uploaded_at)
	VALUES
	(images_id_seq.NEXTVAL, #{postId}, #{fileName}, #{originalFileName}, #{filePath}, #{urlFilePath},
	#{fileExtension}, #{uploadedAt})
	</insert>
	
	<insert id="savePost" parameterType="Post">
		INSERT INTO post (post_id, user_id, nick_name, board_id, post_product_type, post_title, post_content, post_sales_unit, post_price, post_spot, post_cost, store_id) 
	    VALUES (post_id_seq.NEXTVAL, #{userId}, #{nickName}, #{boardId}, #{postProductType}, #{postTitle}, #{postContent}, #{postSalesUnit}, #{postPrice}, #{postSpot},#{postCost}, #{storeId})
	</insert>
	
	<insert id="savePostJjim" parameterType="Jjim">
		INSERT INTO jjim (post_id, user_id) VALUES (#{postId}, #{userId})
	</insert>
	
	<select id="getPostJjim" parameterType="Jjim" resultType="Jjim">
		SELECT * FROM jjim WHERE post_id = #{postId} AND user_id = #{userId}
	</select>
	
	<update id="modifyPostImages" parameterType="Image">
	    UPDATE image
	    SET file_name = #{fileName},
	        original_file_name = #{originalFileName},
	        file_path = #{filePath},
	        url_file_path = #{urlFilePath},
	        file_extension = #{fileExtension},
	        uploaded_at = #{uploadedAt}
	    WHERE post_id = #{postId}
	</update>
	
	<update id="saveThumbnailImage">
		 UPDATE post p
        SET p.url_file_path = (
            SELECT i.url_file_path
            FROM image i
            WHERE i.post_id = p.post_id
            AND i.image_id = (
                SELECT MIN(image_id)
                FROM image
                WHERE post_id = p.post_id
            )
        )
        WHERE EXISTS (
            SELECT 1
            FROM image i
            WHERE i.post_id = p.post_id
        )
	</update>
	
	<update id="addPostViewsByPostId" parameterType="String">
		UPDATE post SET post_views = post_views + 1 WHERE post_id = #{postId}
	</update>
	
	<update id="modifyPost" parameterType="Post">
	    UPDATE post
	    SET user_id = #{userId},
	        nick_name = #{nickName},
	        board_id = #{boardId},
	        post_product_type = #{postProductType},
	        post_title = #{postTitle},
	        post_content = #{postContent},
	        post_sales_unit = #{postSalesUnit},
	        post_price = #{postPrice},
	        post_spot = #{postSpot},
	        post_cost = #{postCost},
	        store_id = #{storeId}
	    WHERE post_id = #{postId}
	</update>
	
	<delete id="deletePostImagesByPostId" parameterType="String">
		DELETE FROM image WHERE post_id = #{postId}
	</delete>
	
	<delete id="deletePostJjim" parameterType="Jjim">
		DELETE FROM jjim WHERE post_id = #{postId} AND user_id = #{userId}
	</delete>
	
	<update id="deletePostByPostId" parameterType="String">
		UPDATE post SET post_state = 'N' WHERE post_id = #{postId}
	</update>

	<select id="getLastPostId" resultType="String">
		SELECT post_id_seq.CURRVAL FROM DUAL
	</select>
	
	<select id="getPostDetailsByPostId" parameterType="String"
		resultType="Post">
		SELECT * FROM post WHERE post_id = #{postId} order by post_id
	</select>
	
	<select id="getPostDetailsImageUrlsByPostId" parameterType="String"
		resultType="String">
		select url_file_path from image where post_id = #{postId} order by post_id
	</select>
	
	<select id="getPostList" resultType="Post">
		select * from post where post_state = 'Y'
	</select>
	
	<select id="getPostListByRelatedData" parameterType="String" resultType="Post">
		select * from post where post_state = 'Y' AND post_product_type = #{relatedData}
	</select>

<!-- 	<select id="selectPostsByUserId" resultType="Post"> -->
<!--         SELECT  -->
<!--             post_id AS postId, -->
<!--             user_id AS userId, -->
<!--             post_title, -->
<!--             post_content, -->
<!--             post_created_at AS createdAt -->
<!--         FROM  -->
<!--             post -->
<!--         WHERE  -->
<!--             user_id = #{userId} -->
<!--         ORDER BY  -->
<!--             post_created_at DESC -->
<!--     </select> -->
    
<!--     <select id="selectPostById" resultType="Post"> -->
<!--         SELECT  -->
<!--             post_id AS postId, -->
<!--             user_id AS userId, -->
<!--             post_title, -->
<!--             post_content, -->
<!--             post_created_at AS createdAt -->
<!--         FROM  -->
<!--             post -->
<!--         WHERE  -->
<!--             post_id = #{postId} -->
<!--     </select> -->
	
	
	
	
	
</mapper>