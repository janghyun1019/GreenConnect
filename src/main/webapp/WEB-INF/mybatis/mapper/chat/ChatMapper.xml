<!-- src/main/resources/mappers/ChatMapper.xml -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ChatMapper">
    <!-- 채팅방 목록 조회 -->
    <select id="findChatRoomsByUserId" resultType="com.example.chatapp.dto.ChatRoomDTO">
        SELECT room_id, user1_id, user2_id, user1_active, user2_active
        FROM chat_room
        WHERE user1_id = #{userId} OR user2_id = #{userId}
    </select>

    <!-- 메시지 저장 -->
    <insert id="saveMessage" parameterType="map">
        INSERT INTO chat_message (message_id, room_id, sender_id, content, image_urls)
        VALUES (chat_message_seq.NEXTVAL, #{roomId}, #{senderId}, #{content}, #{imageUrls})
    </insert>

    <!-- 마지막 삽입된 메시지 ID 조회 -->
    <select id="getLastInsertedId" resultType="long">
        SELECT chat_message_seq.CURRVAL FROM dual
    </select>

    <!-- 채팅방 정보 조회 -->
    <select id="findChatRoomById" resultType="com.example.chatapp.dto.ChatRoomDTO">
        SELECT room_id, user1_id, user2_id, user1_active, user2_active
        FROM chat_room
        WHERE room_id = #{roomId}
    </select>

    <!-- 메시지 읽음 상태 업데이트 -->
    <update id="markMessageAsRead" parameterType="long">
        UPDATE chat_message SET read_by_receiver = 'Y' WHERE message_id = #{messageId}
    </update>

    <!-- 채팅방 활성 상태 업데이트 -->
    <update id="updateChatRoomActiveStatus" parameterType="map">
        UPDATE chat_room
        SET 
            <if test="userId == user1_id">user1_active = #{status}</if>
            <if test="userId == user2_id">user2_active = #{status}</if>
        WHERE room_id = #{roomId}
    </update>
</mapper>